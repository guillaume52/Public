function getSampleSize(e,t,n){let i=e,a=t,o=n,r=o-o*i,s=Math.abs(o*i),u=o*(1-o)+r*(1-r),l=2*a*u*Math.log(1+Math.sqrt(u)/s)/(s*s);return Math.round(l)}function xlfNormSDist(e){if(e<0)return 1-xlfNormSDist(-e);var t=1/(1+.2316419*e);return 1-Math.exp(-e*e/2)/Math.sqrt(2*Math.PI)*t*(.31938153+t*(t*(1.781477937+t*(1.330274429*t-1.821255978))-.356563782))}function xlfNormalPDF1a(e,t,n){return Math.exp(-Math.pow(e-t,2)/(2*Math.pow(n,2)))/(n*Math.sqrt(2*Math.PI))}function xlfNormalPDF1b(e,t,n){return Math.exp(-.5*Math.pow((e-t)/n,2))/(n*Math.sqrt(2*Math.PI))}function xlfNormalSdistPDF(e){return Math.exp(-.5*e*e)/Math.sqrt(2*Math.PI)}var iframe=document.querySelector('[name="galaxy"]').contentWindow.document,pagination=iframe.querySelector(".C_PAGINATION_ROWS_LONG > label").innerText.split(" of ");pagination[0].split("1-")[1]<pagination[1]&&alert("make sure the page is displaying all the rows - currently dipslaying only "+pagination[0].split("1-")[1]+" there is however a total of "+pagination[1]);let Label=first=second=third=fourth=fifth=segment=sessions="empty";function Dimensions(e,t,n,i,a,o,r,s){this.Label=e,this.First=t,this.Second=n,this.Third=i,this.Fourth=a,this.Fifth=o,this.Segment=r,this.Sessions=s,this.Concat=""}function Results(e,t,n,i){this.Label=e,this.Segment=n,this.Sessions=i,this.Concat=t}function Results_final(e,t,n,i,a,o,a,r,s,u,l,d,c){this.Label=e,this.Concat=t,this.Segment=n,this.control_users=i,this.variant_users=o,this.control_conversion=a,this.variant_conversion=r,this.control_cvr=(100*s).toFixed(2),this.variant_cvr=(100*u).toFixed(2),this.Uplift=(100*uplift).toFixed(2),this.ConfLevel=(100*l).toFixed(2),isNaN(getSampleSize(uplift,.95,s))?this.SampleSizeRequired=0:this.SampleSizeRequired=getSampleSize(uplift,.95,s),this.DaysToEnoughData=d/o/c,this.EnoughData=d<o?"Enough data collected":"need more data",(100*l).toFixed(2)>.95&&d<o?this.StatSig="Positive & SS":(100*l).toFixed(2)<.05&d<o?this.StatSig="Negative & SS":this.StatSig="Cant conclude yet"}var _table_=document.createElement("table"),_tr_=document.createElement("tr"),_th_=document.createElement("th"),_td_=document.createElement("td");function buildHtmlTable(e){for(var t=_table_.cloneNode(!1),n=addAllColumnHeaders(e,t),i=0,a=e.length;i<a;++i){for(var o=_tr_.cloneNode(!1),r=0,s=n.length;r<s;++r){var u=_td_.cloneNode(!1);cellValue=e[i][n[r]],u.appendChild(document.createTextNode(e[i][n[r]]||"")),o.appendChild(u)}t.appendChild(o)}return t}function addAllColumnHeaders(e,t){for(var n=[],i=_tr_.cloneNode(!1),a=0,o=e.length;a<o;a++)for(var r in e[a])if(e[a].hasOwnProperty(r)&&-1===n.indexOf(r)){n.push(r);var s=_th_.cloneNode(!1);s.appendChild(document.createTextNode(r)),i.appendChild(s)}return t.appendChild(i),n}var dimensions=[],dimensions_array=[];for(dimensions=iframe.querySelectorAll('[class^="ID-dimension-data-"]'),i=0;i<dimensions.length;i++)dimensions_array.push(dimensions[i].className),console.log(dimensions_array);(dimensions=new Set(dimensions_array)).size,dimensions_name=iframe.querySelectorAll('[data-guidedhelpid*="data-table-dimension-analytics"]');let dimensions_name_list=[];for(t=1;t<dimensions_name.length;t++)dimensions_name_list.push(dimensions_name[t].innerText);var count_group=[];for(count_group_list=iframe.querySelectorAll('[class^="ID-row-"]'),i=0;i<count_group_list.length;i++)count_group.push(iframe.querySelectorAll('[class^="ID-row-"]')[i].getAttribute("class"));var total_array=[],sessions_array=[];for(i=0;i<count_group.filter(e=>!e.includes("ACTION-mouse")).length;i++)for(console.log(i),j=0;j<count_group.filter(e=>e.includes("ACTION-mouse")).length/count_group.filter(e=>!e.includes("ACTION-mouse")).length;j++){var total=[],read_dimensions=[],dimensions_array_columns=[];for(k=0;k<dimensions.size;k++)read_dimensions="#ID-rowTable > tbody > tr.ID-row-"+i+"> td.ID-dimension-data-"+k,dimensions_array_columns.push(iframe.querySelector(read_dimensions).innerText);segment="#ID-rowTable > tbody > tr.ID-row-"+i+"-0-"+j+".ACTION-mouse.TARGET-row-"+i+"-0-"+j+"> td:nth-child(2) > span",sessions="#ID-rowTable > tbody > tr.ID-row-"+i+"-0-"+j+".ACTION-mouse.TARGET-row-"+i+"-0-"+j+" > td.COLUMN-analytics\\.visits",Label=dimensions_array_columns[0],null==dimensions_array_columns[1]||(first=dimensions_array_columns[1]),null==dimensions_array_columns[2]||(second=dimensions_array_columns[2]),null==dimensions_array_columns[3]||(third=dimensions_array_columns[3]),null==dimensions_array_columns[4]||(fourth=dimensions_array_columns[4]),null==dimensions_array_columns[5]||(fifth=dimensions_array_columns[5]),segment=iframe.querySelectorAll(segment)[0].innerText,sessions=iframe.querySelector(sessions).innerText.split(" (")[0].replace(",",""),total_array.push(new Dimensions(Label,first,second,third,fourth,fifth,segment,sessions)),console.log(new Dimensions(Label,first,second,third,fourth,fifth,segment,sessions))}const getValue=(e,t)=>{let n=e;return t.split(".").forEach(e=>{n=n[e]}),n};let grouping_dimensions="",unique_concat=[],unique_segment=[],unique_variant=[],Results_array=[];var group_dim=function(t){for(unique_concat=[],unique_segment=[],unique_variant=[],q=0;q<total_array.length;q++){var n=[];for(unique_segment.push(getValue(total_array,q+".Segment")),unique_variant.push(getValue(total_array,q+".Label")),w=0;w<t.length;w++)n.push(getValue(total_array,q+"."+t[w])),total_array[q].Concat=n.join("_"),console.log(n.join("_"));unique_concat.push(n.join("_"))}for(unique_concat=[...new Set(unique_concat)].sort(),unique_segment=[...new Set(unique_segment)].sort(),unique_variant=[...new Set(unique_variant)].sort(),Results_array=[],e=0;e<unique_concat.length;e++){var i=[];for(d=0;d<unique_segment.length;d++)for(f=0;f<unique_variant.length;f++)i=total_array.filter(function(t){return t.Concat==unique_concat[e]&&t.Label==unique_variant[f]&&t.Segment==unique_segment[d]}).reduce(function(e,t){return e+parseInt(t.Sessions)},0),Results_array.push(new Results(unique_variant[f],unique_concat[e],unique_segment[d],i))}};group_dim(grouping_dimensions);let StartDate=iframe.querySelector(".ID-start").textContent,Date_start=new Date(StartDate),EndDate=iframe.querySelector(".ID-end").textContent,Date_end=new Date(EndDate),Days_run=(Date.parse(Date_end)-Date.parse(Date_start))/1e3/60/60/24,users_segment=unique_segment[0],control_label=unique_variant[0],Results_array_math=[];var results_display=function(e,t){var n=unique_segment.filter(e=>!t.includes(e));for(Results_array_math=[],g=0;g<unique_concat.length;g++)for(f=0;f<unique_variant.length;f++){var i=[],a=[],o=[],r=[],s=[],u=[],l=[],c=[],m=[];for(d=0;d<n.length;d++)i=Results_array.filter(function(n){return n.Concat==unique_concat[g]&&n.Label==e&&n.Segment==t}).reduce(function(e,t){return e+parseInt(t.Sessions)},0),o=Results_array.filter(function(e){return e.Concat==unique_concat[g]&&e.Label==unique_variant[f]&&e.Segment==t}).reduce(function(e,t){return e+parseInt(t.Sessions)},0),s=(a=Results_array.filter(function(t){return t.Concat==unique_concat[g]&&t.Label==e&&t.Segment==n[d]}).reduce(function(e,t){return e+parseInt(t.Sessions)},0))/i,u=(r=Results_array.filter(function(e){return e.Concat==unique_concat[g]&&e.Label==unique_variant[f]&&e.Segment==n[d]}).reduce(function(e,t){return e+parseInt(t.Sessions)},0))/o,uplift=(u-s)/s,l=Math.pow(s*(1-s)/i,.5),c=Math.pow(u*(1-u)/o,.5),m=xlfNormSDist((u-s)/Math.pow(Math.pow(l,2)+Math.pow(c,2),.5)),SampleSize=getSampleSize(uplift,.95,s),Results_array_math.push(new Results_final(unique_variant[f],unique_concat[g],n[d],i,a,o,a,r,s,u,m,SampleSize,Days_run))}};const newNode=iframe.createElement("div");newNode.setAttribute("id","AB_Div");const RadioNode=iframe.createElement("div");RadioNode.setAttribute("id","Radio_Label");const CheckboxNode=iframe.createElement("div");CheckboxNode.setAttribute("id","Checkbox_Label");const SegmentRadioNode=iframe.createElement("div");SegmentRadioNode.setAttribute("id","SegmentRadio_Label");const btn=iframe.createElement("button");btn.setAttribute("class","btn btn-primary"),btn.innerHTML="Delete All tables",btn.name="deleteTable",btn.onclick=function(){var e=iframe.querySelectorAll(".AB_Results_Table");[].forEach.call(e,function(e){e.remove()})};const list=iframe.getElementById("ID-tabControl");list.insertBefore(newNode,list.children[0]),newNode.appendChild(btn),newNode.appendChild(RadioNode),newNode.appendChild(CheckboxNode),newNode.appendChild(SegmentRadioNode);for(var output="",output2="",output3="",unique_dimensions=["First","Second","Third","Fourth","Fifth"],i=0;i<unique_variant.length;i++)output2+=0==i?"Choose the control: "+unique_variant[i]+':<input type="radio" checked="true" value="'+unique_variant[i]+'" name="Label">':unique_variant[i]+':<input type="radio" value="'+unique_variant[i]+'" name="Label">',iframe.getElementById("Radio_Label").innerHTML=output2;for(var ii=0;ii<unique_segment.length;ii++)output3+=0==ii?"Choose the User base: "+unique_segment[ii]+':<input type="radio" checked="true" value="'+unique_segment[ii]+'" name="Segment">':unique_segment[ii]+':<input type="radio" value="'+unique_segment[ii]+'" name="Segment">',iframe.getElementById("SegmentRadio_Label").innerHTML=output3;output="Split by: ";for(var iii=0;iii<dimensions_name_list.length;iii++)output+='<input type="checkbox" value='+unique_dimensions[iii]+' name="checkbox_dimensions">   '+dimensions_name_list[iii]+"   ",iframe.getElementById("Checkbox_Label").innerHTML=output;let renderTable=function(e){var t=document.body.appendChild(buildHtmlTable(e));t.setAttribute("class","AB_Results_Table"),t.setAttribute("id","table"+unique_concat),t.setAttribute("border","1px solid"),t.setAttribute("width","100%"),t.style.color="black",newNode.appendChild(t);let n="",i=Object.keys(e[0]).join(","),a=e.map(e=>Object.values(e).join(",")).join("\n");var o=encodeURI(n+="data:text/csv;charset=utf-8,"+i+"\n"+a);const r=iframe.createElement("a");r.setAttribute("href",o),r.setAttribute("download",StartDate+"_"+EndDate+"("+Days_run+"days_run) "+unique_concat+".csv"),r.setAttribute("class","AB_Results_Table"),r.innerHTML="Download CSV",r.name="Download CSV",newNode.appendChild(r)};results_display(control_label,users_segment),renderTable(Results_array_math);let grouping_dimensions_compare=[],checkboxValues=[];function timeout(){setTimeout(function(){if(control_label_compare=iframe.querySelector('input[name="Label"]:checked').value,segment_compare=iframe.querySelector('input[name="Segment"]:checked').value,0==(checkboxValues=iframe.querySelectorAll('input[name="checkbox_dimensions"]:checked')).length)console.log("pas de loop grouping_dimensions_compare"+grouping_dimensions_compare),grouping_dimensions_compare="",console.log("assigned grouping_dimensions_compare"+grouping_dimensions_compare);else for(grouping_dimensions_compare=[],r=0;r<checkboxValues.length;r++)grouping_dimensions_compare.push(String(checkboxValues[r].value));control_label_compare==control_label&&segment_compare==users_segment&&String(grouping_dimensions_compare)==String(grouping_dimensions)||(group_dim(grouping_dimensions_compare),results_display(control_label_compare,segment_compare),renderTable(Results_array_math),control_label=control_label_compare,grouping_dimensions=grouping_dimensions_compare,users_segment=segment_compare),timeout()},2500)}timeout();
